name: Deploy ParcelTrack

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ---------------------------
    # FRONTEND BUILD (Vite)
    # ---------------------------
    - name: Install Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install frontend deps
      working-directory: Java_Sem3_Project/frontend
      run: npm install

    - name: Build frontend
      working-directory: Java_Sem3_Project/frontend
      run: npm run build

    # ---------------------------
    # BACKEND BUILD (Java 21)
    # ---------------------------
    - name: Setup JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Build backend
      working-directory: Java_Sem3_Project/backend
      run: ./mvnw clean package -DskipTests

    # ---------------------------
    # COPY FILES TO SERVER
    # ---------------------------
    - name: Copy frontend + backend to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        timeout: 120s
        source: |
          Java_Sem3_Project/frontend/dist/**
          Java_Sem3_Project/backend/target/demo-0.0.1-SNAPSHOT.jar
        target: /home/aryan/deploy_temp/

    # ---------------------------
    # DEPLOY ON SERVER
    # ---------------------------
    - name: SSH & deploy
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          echo "Stopping backend..."
          sudo systemctl stop backend || true

          echo "Updating frontend build..."
          sudo rm -rf /home/aryan/Java_Sem3_Project/frontend/dist/*
          sudo cp -r /home/aryan/deploy_temp/Java_Sem3_Project/frontend/dist/* /home/aryan/Java_Sem3_Project/frontend/dist/

          echo "Updating backend jar..."
          sudo cp /home/aryan/deploy_temp/Java_Sem3_Project/backend/target/demo-0.0.1-SNAPSHOT.jar /home/aryan/Java_Sem3_Project/backend/target/demo-0.0.1-SNAPSHOT.jar

          echo "Restarting backend..."
          sudo systemctl start backend

          echo "Reloading nginx..."
          sudo systemctl reload nginx

          echo "Cleaning temp deploy folder..."
          sudo rm -rf /home/aryan/deploy_temp

          echo "Deployment complete!"
